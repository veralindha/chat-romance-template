"use strict";

exports.__esModule = true;
exports.render = render;
exports.default = void 0;

var _vue = require("vue");

var _props = require("./props");

var _elements = require("../utils/elements");

var _zIndex = require("../context/zIndex");

var _components = require("../utils/components");

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

function render(_ctx, _cache) {
  return (0, _vue.openBlock)(), (0, _vue.createElementBlock)("div", {
    class: "var-menu",
    ref: "host",
    onClick: _cache[1] || (_cache[1] = (...args) => _ctx.handleClick && _ctx.handleClick(...args))
  }, [(0, _vue.renderSlot)(_ctx.$slots, "default"), ((0, _vue.openBlock)(), (0, _vue.createBlock)(_vue.Teleport, {
    to: _ctx.teleport,
    disabled: !_ctx.teleport || _ctx.disabled
  }, [(0, _vue.createVNode)(_vue.Transition, {
    name: "var-menu",
    onAfterEnter: _ctx.onOpened,
    onAfterLeave: _ctx.onClosed
  }, {
    default: (0, _vue.withCtx)(() => [(0, _vue.withDirectives)((0, _vue.createElementVNode)("div", {
      class: "var-menu__menu var-elevation--3",
      ref: "menu",
      style: (0, _vue.normalizeStyle)({
        top: "calc(" + _ctx.top + "px + " + _ctx.toSizeUnit(_ctx.offsetY) + ")",
        left: "calc(" + _ctx.left + "px + " + _ctx.toSizeUnit(_ctx.offsetX) + ")",
        zIndex: _ctx.zIndex
      }),
      onClick: _cache[0] || (_cache[0] = (0, _vue.withModifiers)(() => {}, ["stop"]))
    }, [(0, _vue.renderSlot)(_ctx.$slots, "menu")], 4
    /* STYLE */
    ), [[_vue.vShow, _ctx.show]])]),
    _: 3
    /* FORWARDED */

  }, 8
  /* PROPS */
  , ["onAfterEnter", "onAfterLeave"])], 8
  /* PROPS */
  , ["to", "disabled"]))], 512
  /* NEED_PATCH */
  );
}

var _default = (0, _vue.defineComponent)({
  render,
  name: 'VarMenu',
  props: _props.props,

  setup(props) {
    var host = (0, _vue.ref)(null);
    var menu = (0, _vue.ref)(null);
    var top = (0, _vue.ref)(0);
    var left = (0, _vue.ref)(0);
    var {
      zIndex
    } = (0, _zIndex.useZIndex)(() => props.show, 1);
    var {
      disabled
    } = (0, _components.useTeleport)();
    var clickSelf = false;

    var computeTop = alignment => {
      return alignment === 'top' ? (0, _elements.getTop)(host.value) : (0, _elements.getTop)(host.value) - menu.value.offsetHeight;
    };

    var handleClick = () => {
      clickSelf = true;
    };

    var handleMenuClose = () => {
      var _props$onUpdateShow;

      if (clickSelf) {
        clickSelf = false;
        return;
      }

      if (!props.show) {
        return;
      }

      (_props$onUpdateShow = props['onUpdate:show']) == null ? void 0 : _props$onUpdateShow.call(props, false);
    }; // expose


    var resize = () => {
      top.value = computeTop(props.alignment);
      left.value = (0, _elements.getLeft)(host.value);
    };

    (0, _vue.watch)(() => props.alignment, resize);
    (0, _vue.watch)(() => props.show, /*#__PURE__*/function () {
      var _ref = _asyncToGenerator(function* (newValue) {
        var {
          onOpen,
          onClose
        } = props;
        newValue && resize();
        newValue ? onOpen == null ? void 0 : onOpen() : onClose == null ? void 0 : onClose();
      });

      return function (_x) {
        return _ref.apply(this, arguments);
      };
    }());
    (0, _vue.onMounted)(() => {
      resize();
      document.addEventListener('click', handleMenuClose);
      window.addEventListener('resize', resize);
    });
    (0, _vue.onUnmounted)(() => {
      document.removeEventListener('click', handleMenuClose);
      window.removeEventListener('resize', resize);
    });
    return {
      disabled,
      zIndex,
      host,
      menu,
      top,
      left,
      toSizeUnit: _elements.toSizeUnit,
      handleClick,
      resize
    };
  }

});

exports.default = _default;